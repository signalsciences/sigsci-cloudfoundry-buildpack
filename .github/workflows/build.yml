name: build sigsci-cloudfoundry-buildpack
on:
  push:
    branches: bbucher-23974-release-pipeline
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo
      - name: Get Version
        run: |
          echo ::set-env name=VERSION::$(cat VERSION)
      - name: Get Commit Messages
        run: |
          echo ::set-env name=COMMIT_MESSAGES::$(curl -u ${{ github.actor }}:${{ github.token }} "https://api.github.com/repos/signalsciences/sigsci-cloudfoundry-buildpack/commits/${{ github.sha }} | jq .commit.message)
      - name: Rename README
        run: |
          echo "Version: ${VERSION}" > README-SIGSCI.md
          cat README.md >> README-SIGSCI.md
          rm README.md
      - name: Commit files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README-SIGSCI.md
          git commit -m "Rename README.md to README-SIGSCI.md" -a
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          branch: ${{ env.VERSION }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -u ${{ github.actor }}:${{ github.token }} -d '{"tag_name":"${{ env.VERSION }}", "target_commitish":"${{ env.VERSION }}", "name":"Release ${{ env.VERSION }}", "draft":false, "prerelease":false, "body":"${{ env.COMMIT_MESSAGES }}"}' -H "Content-Type: application/json" -X POST https://api.github.com/repos/signalsciences/sigsci-cloudfoundry-buildpack/releases